<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<meta charset="utf-8">
<head th:include="include :: header"></head>
<body>
<div class="form-content">
    <form class="form-horizontal">
        <h4 class="form-header h2">报告信息</h4>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>报告名称：</label>
                    <input name="enterpriseReportTemplateId" type="hidden">
                    <div class="col-sm-8">
                        <input name="name" autocomplete="off" class="form-control" type="text" th:value="${entReportTemp.name}" readonly>
                        <input id="enterpriseReportTemplateId" name="enterpriseReportTemplateId" type="hidden" th:value="${entReportTemp.enterpriseReportTemplateId}">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>生成周期：</label>
                    <div class="col-sm-8">
                        <div class="input-group" style="width: 100%">
                            <select name="makeCycle" class="form-control m-b" th:with="type=${@fangCloudDict.getType('TargetModelMakeCycle')}" disabled>
                                <option th:each="fangCloudDict : ${type}" th:text="${fangCloudDict.valueDesc}" th:value="${fangCloudDict.value}" th:selected="${entReportTemp.makeCycle eq fangCloudDict.value}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>>
    <div  class="col-sm-12 select-table table-striped">
        <h4 class="form-header h2">邮件信息</h4>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>收件人：</label>
                    <div class="col-sm-6">
                        <div class="input-group" style="width: 100%">
                            <select id="receiverSelect" class="form-control m-b" multiple th:with="entUser=${entUserList}">
                                <option value="">未选择</option>
                                <option th:each="entUser : ${entUser}" th:text="${entUser.name}" th:value="${entUser.userId}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <a class="btn btn-success btn-sm" onclick="addReceiver('00')">
                            <i class="fa fa-plus"></i> 添加
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>抄送人：</label>
                    <div class="col-sm-6">
                        <div class="input-group" style="width: 100%">
                            <select id="copySelect" class="form-control m-b" multiple th:with="entUser=${entUserList}">
                                <option value="">未选择</option>
                                <option th:each="entUser : ${entUser}" th:text="${entUser.name}" th:value="${entUser.userId}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <a class="btn btn-success btn-sm" onclick="addReceiver('01')">
                            <i class="fa fa-plus"></i> 添加
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="btn-group-sm" id="toolbar" role="group">
            <h4 class="form-header h2">邮件信息</h4>
        </div>
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table" data-mobile-responsive="true"></table>
        </div>
    </div>
</div>

<div th:include="include::footer"></div>
<script th:src="@{/ajax/libs/select/select2.js}"></script>
<script th:inline="javascript">

    var removeFlag = [[${@permission.hasPermi('report:mail:remove')}]];

    $(function() {
        var entReportTempId = document.getElementById("enterpriseReportTemplateId").value;
        console.log("entReportTempId = ", entReportTempId);
        queryEntUser3RList(entReportTempId);
    });

    function queryEntUser3RList(entReportTempId) {
        var options = {
            url: ctx + "report/mail/getEntUser3RList/" + entReportTempId,
            removeUrl: ctx + "report/mail/remove",
            sortName: "createDate",
            sortOrder: "desc",
            modalName: "邮件信息",
            columns: [
                {
                    field: 'id',
                    title: '编号'
                },
                {
                    field: 'enterpriseUserName',
                    title: '姓名'
                },
                {
                    field: 'enterpriseUserId',
                    title: '员工编号'
                },
                {
                    field: 'email',
                    title: '邮箱地址'
                },
                {
                    field: 'userType',
                    title: '接收类型'
                },
                {
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="#" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a>');
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);
    }

    function addReceiver(type) {
        var entReportTempId = document.getElementById("enterpriseReportTemplateId").value;
        var userIds = ((type == '00') ? $('#receiverSelect').val() : $('#copySelect').val());
        var data = {"userIds": userIds.join(','), "userType": type, "enterpriseReportTemplateId": entReportTempId};
        console.log("data = ", data);
        $.ajax({
            url: ctx + "report/mail/add",
            data: data,
            type: "POST",
            success: function (result) {
                if (result.code == web_status.SUCCESS) {
                    queryEntUser3RList(entReportTempId);
                } else {
                    $.modal.alertError(result.msg);
                }
            }
        });
    }

</script>
</body>
</html>