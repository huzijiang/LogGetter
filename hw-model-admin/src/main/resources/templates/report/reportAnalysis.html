<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<link th:href="@{/ajax/libs/jquery-layout/jquery.layout-latest.css}" rel="stylesheet"/>
<script th:src="@{/ueditor/ueditor.config.js}"></script>
<script th:src="@{/ueditor/ueditor.all.js}"></script>
<style>
    .target-row{
        margin: 10px;height:330px;background: #fff;border-radius: 6px;box-shadow: 1px 1px 3px rgba(0,0,0,.2);
    }
    .target-col{
        padding-top: 10px;padding-left: 10px;
    }
</style>
<body class="gray-bg">
<div class="container ui-layout-center">
    <div class="row target-row">
        <div class="col-md-12 target-col">
            <h2><p class="enterpriseNameArea"></p></h2>
            <hr>
            <div>
                <script id="reportPublishContentContainer" type="text/plain"></script>
            </div>
        </div>
    </div>
    <div class="target-container">

    </div>

    <div style="float: bottom;margin-bottom: 10px;text-align: center;">
        <button class="btn btn-success" onclick="reportPublish()" th:style="${type == 'detail'} ? 'display:none;'">发布</button>
        <button class="btn btn-danger" onclick="closeItem()">退出</button>
    </div>
</div>

<div th:include="include :: footer"></div>
<script th:src="@{/ajax/libs/jquery-layout/jquery.layout-latest.js}"></script>
<!-- 引入 ECharts 文件 -->
<script th:src="@{/js/echarts.min.js}"></script>
<script type="text/javascript">

</script>
<script th:inline="javascript">
    var enterpriseData = [[${@platformDict.getEnterpriseList()}]];
    var type = [[${type}]];
    var reportTargetDataList = [[${reportTargetDataList}]];

    //初始化：报告发布富文本编辑框
    var ue = UE.getEditor('reportPublishContentContainer', {
        toolbars: [
            [
                'undo', //撤销
                'redo', //重做
                'bold', //加粗
                'indent', //首行缩进
                'italic', //斜体
                'underline', //下划线
                'strikethrough', //删除线
                'subscript', //下标
                'formatmatch', //格式刷
                'preview', //预览
                'horizontal', //分隔线
                'cleardoc', //清空文档
                'fontfamily', //字体
                'fontsize', //字号
                'paragraph', //段落格式
                'emotion', //表情
                'spechars', //特殊字符
                'justifyleft', //居左对齐
                'justifyright', //居右对齐
                'justifycenter', //居中对齐
                'justifyjustify', //两端对齐
                'forecolor', //字体颜色
                'backcolor', //背景色
                'insertorderedlist', //有序列表
                'insertunorderedlist', //无序列表
                'fullscreen', //全屏
                'lineheight' //行间距
            ]
        ],
        autoHeightEnabled: false,
        autoFloatEnabled: true,
        elementPathEnabled : false,
        maximumWords: 1000
    });
    ue.ready(function() {
        var reportPublishContent = reportTargetDataList[0].reportPublishContent;
        var uePlaceholder =  "请填写报告分析结果...";
        ue.setHeight(160);
        if (type == "detail") {
            //去富文本编辑器 "本地保存" 提示框
            $(".edui-editor-messageholder.edui-default").css({ "visibility": "hidden" });
            ue.setDisabled(['fullscreen','preview']);
            uePlaceholder = "该报告暂无分析内容";
        }
        ue.setContent($.common.isEmpty(reportPublishContent) ? uePlaceholder : reportPublishContent);
    });

    $(function() {
        var panehHidden = false;
        if ($(this).width() < 769) {
            panehHidden = true;
        }
        $('body').layout({ initClosed: panehHidden, west__size: 185 });
        console.log("reportTargetDataList = ", reportTargetDataList);
        initData(reportTargetDataList);
        generateTargetPanel(reportTargetDataList);
        loopShowTargetData(reportTargetDataList);
    });

    /**
     * 初始化数据
     */
    function initData(reportTargetDataList) {
        var enterpriseId = reportTargetDataList[0].enterpriseId;
        var enterpriseName = "某公司";
        $.each(enterpriseData, function(index, enterprise) {
            if (enterprise.enterpriseId == ('' + enterpriseId)) {
                enterpriseName = enterprise.name;
            }
        });

        $(".enterpriseNameArea").html(enterpriseName + "——" + reportTargetDataList[0].reportName);
    }

    /**
     * 生成每个指标所在的面板区域
     */
    function generateTargetPanel(reportTargetDataList) {
        var targetContainer = document.getElementsByClassName('target-container')[0];

        for (var count = 0; count < reportTargetDataList.length; count++) {
            // 分类：指标结果集 groupName 是 Hp_qua_effi、Hp_tired_index、Hp_comp_rank
            // 表示直接展示该指标内容(json串)，无需渲染成 ECharts
            var groupName = reportTargetDataList[count].groupName;
            var notShowEChars = !$.common.isEmpty(groupName) && ("Hp_qua_effi" == groupName || "Hp_tired_index" == groupName || "Hp_comp_rank" == groupName);

            var targetRowDiv = document.createElement("div");
            targetRowDiv.setAttribute("class","row target-row");

            var targetColDiv = document.createElement("div");
            targetColDiv.setAttribute("class","col-md-12 target-col");

            var targetPanelDiv = document.createElement("div");
            targetPanelDiv.setAttribute("id", "targetPanel" + count);
            targetPanelDiv.setAttribute("style", "float:left;width: 70%;height: 300px;box-shadow: 1px 1px 3px rgba(0,0,0,.2);");

            var targetTextarea = document.createElement("textarea");
            if(notShowEChars) {
                targetTextarea.setAttribute("row", "30");
                targetTextarea.setAttribute("style", "resize:none;min-width: 100%;height: 100%;");
                targetTextarea.setAttribute("readonly", "readonly");
            }

            var targetPublishTextareaDiv = document.createElement("div");
            targetPublishTextareaDiv.setAttribute("style", "margin-right:5px;padding-top: 10px;float:right;width: 28%;height: 300px;");

            var targetIdInput = document.createElement("input");
            targetIdInput.hidden = true;
            targetIdInput.setAttribute("id", "targetIdInput" +  count);
            targetIdInput.setAttribute("key-targetDataId", reportTargetDataList[count].enterpriseTargetDataId);
            targetIdInput.value = reportTargetDataList[count].targetDataPublishContent;

            targetContainer.appendChild(targetRowDiv);
            targetRowDiv.appendChild(targetColDiv);
            targetColDiv.appendChild(targetPanelDiv);
            if(notShowEChars){
                targetPanelDiv.appendChild(targetTextarea);
            }
            targetPublishTextareaDiv.innerHTML = '<script id="targetPublishUEditor' + count +'" type="text/plain"><//script>';
            targetPublishTextareaDiv.appendChild(targetIdInput);
            targetColDiv.appendChild(targetPublishTextareaDiv);

        }

        for (var i = 0; i < reportTargetDataList.length; i++) {
            UE.getEditor('targetPublishUEditor'+i, {
                toolbars: [
                    [
                        'undo', //撤销
                        'redo', //重做
                        'bold', //加粗
                        'indent', //首行缩进
                        'italic', //斜体
                        'underline', //下划线
                        'strikethrough', //删除线
                        'subscript', //下标
                        'formatmatch', //格式刷
                        'preview', //预览
                        'horizontal', //分隔线
                        'cleardoc', //清空文档
                        'fontfamily', //字体
                        'fontsize', //字号
                        'paragraph', //段落格式
                        'emotion', //表情
                        'spechars', //特殊字符
                        'justifyleft', //居左对齐
                        'justifyright', //居右对齐
                        'justifycenter', //居中对齐
                        'justifyjustify', //两端对齐
                        'forecolor', //字体颜色
                        'backcolor', //背景色
                        'insertorderedlist', //有序列表
                        'insertunorderedlist', //无序列表
                        'fullscreen', //全屏
                        'lineheight' //行间距
                    ]
                ],
                autoHeightEnabled: false,
                autoFloatEnabled: true,
                elementPathEnabled : false,
                maximumWords: 1000
            }).ready(function () {
                this.setHeight(175);
            });
        }

        var targetUEditorArray = [];
        for (var j = 0; j < reportTargetDataList.length; j++) {
            var item = {
                "uEditor": UE.getEditor('targetPublishUEditor'+j),
                "resultTargetInput": document.getElementById("targetIdInput" + j).value
            };
            targetUEditorArray.push(item);
        }

        $.each(targetUEditorArray, function (index, targetUEditor) {
            targetUEditor.uEditor.ready(function () {
                var targetUePlaceholder =  "请填写报告分析结果...";
                $(".edui-editor-messageholder.edui-default").css({ "visibility": "hidden" });
                if (type == "detail") {
                    targetUEditor.uEditor.setDisabled(['fullscreen','preview']);
                    targetUePlaceholder = "该指标暂无分析内容";
                }
                targetUEditor.uEditor.setContent($.common.isEmpty(targetUEditor.resultTargetInput) ? targetUePlaceholder : targetUEditor.resultTargetInput);
            })
        })
    }

    /**
     * 循环展示各个指标
     */
    function loopShowTargetData(reportTargetDataList) {

        for (var count = 0; count < reportTargetDataList.length; count++) {

            var groupName = reportTargetDataList[count].groupName;
            var notShowEChars = !$.common.isEmpty(groupName) && ("Hp_qua_effi" == groupName || "Hp_tired_index" == groupName || "Hp_comp_rank" == groupName);

            var targetDataFullContent = reportTargetDataList[count].targetDataFullContent;

            if (notShowEChars) {
                document.getElementById('targetPanel'+count).firstChild.innerHTML = targetDataFullContent;
            }else {
                var chart = echarts.init(document.getElementById('targetPanel'+count));

                targetDataFullContent = JSON.parse(targetDataFullContent);
                var optionTitle = targetDataFullContent.title;
                var optionTemp = targetDataFullContent.option; // object
                if (!$.common.isEmpty(JSON.stringify(optionTitle))) {
                    optionTemp.title = eval({text: optionTitle});
                }
                var option = eval('(' + JSON.stringify(optionTemp) + ')');
                chart.setOption(option);
            }
        }
    }

    /**
     * 发布报告
     */
    function reportPublish() {
        var enterpriseReportId = reportTargetDataList[0].reportId;

        var itemArray = [];
        for (var i = 0; i < reportTargetDataList.length; i++) {
            var targetPublishUEditor = UE.getEditor("targetPublishUEditor" + i);
            var resultTargetIdInput = document.getElementById("targetIdInput" + i);
            var item = {
                "enterpriseTargetDataId": resultTargetIdInput.getAttribute("key-targetDataId"),
                "targetDataPublishContent": targetPublishUEditor.getContent()
            };
            itemArray.push(item);
        }
        var jsonData = {"enterpriseReportId": enterpriseReportId, "reportPublishContent":ue.getContent(), "paramData": itemArray};

        $.operate.publishReport(ctx + "report/publish", jsonData);
    }

</script>
</body>
</html>