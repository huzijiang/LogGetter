<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<link th:href="@{/ajax/libs/jquery-layout/jquery.layout-latest.css}" rel="stylesheet"/>
<style>
    .echarts-row{
        margin: 10px;height:330px;background: #fff;border-radius: 6px;box-shadow: 1px 1px 3px rgba(0,0,0,.2);
    }
    .echarts-col{
        padding-top: 10px;padding-left: 10px;
    }
    .baseInfo-row{
        margin: 10px;height:330px;background: #fff;border-radius: 6px;box-shadow: 1px 1px 3px rgba(0,0,0,.2);
    }
</style>
<body class="gray-bg">
<div class="container ui-layout-center">
    <div class="row echarts-row">
        <div class="col-md-12 echarts-col">
            <h2><p class="enterpriseNameArea"></p></h2>
            <hr>
            <p class="reportDescContentArea"></p>
        </div>
    </div>
    <div class="echarts-container">
        <div id="tipDiv" style="display: none;text-align: center;">
            <h3>暂时任何没有指标！</h3>
        </div>
    </div>

    <div style="float: bottom;margin-bottom: 10px;text-align: center;">
        <button class="btn btn-success" onclick="reportPublish()" th:style="${reportTargetDataList[0].enterpriseTargetDataId == null} ? 'display:none;'">发布</button>
        <button class="btn btn-danger" onclick="closeItem()">取消</button>
    </div>
</div>


<div th:include="include :: footer"></div>
<script th:src="@{/ajax/libs/jquery-layout/jquery.layout-latest.js}"></script>
<!-- 引入 ECharts 文件 -->
<script th:src="@{/saas/js/echarts.min.js}"></script>
<script th:inline="javascript">


    $(function() {
        var panehHidden = false;
        if ($(this).width() < 769) {
            panehHidden = true;
        }
        $('body').layout({ initClosed: panehHidden, west__size: 185 });

        var reportTargetDataList = [[${reportTargetDataList}]];
        console.log("reportTargetDataList: ", reportTargetDataList);
        initData(reportTargetDataList);
        if (reportTargetDataList[0].enterpriseTargetDataId != null) {
            generateTargetPanel(reportTargetDataList);
            loopShowTargetData(reportTargetDataList);
        }else {
            $("#tipDiv").css("display","block");
        }
    });

    /**
     * 初始化数据
     */
    function initData(reportTargetDataList) {
        var enterpriseName = reportTargetDataList[0].enterpriseName;
        var reportDescContent = reportTargetDataList[0].reportDescContent;
        $(".enterpriseNameArea").html(enterpriseName == null ? "某公司":enterpriseName + "-报告概述：");
        $(".reportDescContentArea").html(reportDescContent == null ? "无":reportDescContent);

    }

    /**
     * 生成每个指标所在的面板区域
     */
    function generateTargetPanel(reportTargetDataList) {
        var echartsContainer = document.getElementsByClassName('echarts-container')[0];

        for (var count = 0; count < reportTargetDataList.length; count++) {

            var echartsRowDiv = document.createElement("div");
            echartsRowDiv.setAttribute("class","row echarts-row");

            var echartsColDiv = document.createElement("div");
            echartsColDiv.setAttribute("class","col-md-12 echarts-col");

            var echartsDiv = document.createElement("div");
            echartsDiv.setAttribute("id", "echarts" + count);
            echartsDiv.setAttribute("style", "float:left;width: 60%;height: 300px;border:2px solid green");

            var textareaDiv = document.createElement("div");
            textareaDiv.setAttribute("style", "margin-right:10px;padding-top: 10px;float:right;width: 30%;height: 300px;");

            var textAreaElement = document.createElement("textarea");
            textAreaElement.setAttribute("row", "30");
            textAreaElement.setAttribute("style", "min-width: 100%;height: 100%;");
            textAreaElement.setAttribute("placeholder", "填入分析内容...");
            textAreaElement.setAttribute("id", "textarea"+count);
            textAreaElement.setAttribute("key-targetDataId", reportTargetDataList[count].enterpriseTargetDataId);

            echartsContainer.appendChild(echartsRowDiv);
            echartsRowDiv.appendChild(echartsColDiv);
            echartsColDiv.appendChild(echartsDiv);
            textareaDiv.appendChild(textAreaElement);
            echartsColDiv.appendChild(textareaDiv);
        }
    }

    /**
     * 循环展示各个指标
     */
    function loopShowTargetData(reportTargetDataList) {
        var echartsArray = [];
        for (var i = 0; i < reportTargetDataList.length; i++) {
            echartsArray.push(echarts.init(document.getElementById('echarts'+i)));
        }
        for (var i = 0; i < reportTargetDataList.length; i++) {
            var option = eval('(' + reportTargetDataList[i].targetDataFullContent + ')');
            echartsArray[i].setOption(option);
        }
    }

    /**
     * 发布报告
     */
    function reportPublish() {
        var reportTargetDataList = [[${reportTargetDataList}]];
        var enterpriseReportId = reportTargetDataList[0].reportId;
        console.log("enterpriseReportId : ", enterpriseReportId);
        var itemArray = [];
        var flag = false;
        for (var i = 0; i < reportTargetDataList.length; i++) {
            var resultTextareaElement = document.getElementById("textarea" + i);
            if (resultTextareaElement.value == '') {
                $.modal.alertWarning("请将每个指标对应的分析内容填写完整！");
                flag = true;
                break;
            }
            var item = {
                "enterpriseTargetDataId": resultTextareaElement.getAttribute("key-targetDataId"),
                "targetDataPublishContent": resultTextareaElement.value
            };
            itemArray.push(item);
        }
        if (!flag) {
            var jsonData = {"enterpriseReportId": enterpriseReportId, "paramData": itemArray};
            console.log("jsonData:", JSON.stringify(jsonData));
            $.ajax({
                url: ctx + "report/publish",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonData),
                success: function (result) {
                    if (result.code == web_status.SUCCESS) {
                        window.location.href=ctx + "report/list";
                        closeItem();
                    }else {
                        $.modal.alertWarning(result.msg);
                    }
                    // if (result.code == web_status.SUCCESS) {
                    //     var parent = window.parent;
                    //     if (parent.$.table._option.type == table_type.bootstrapTable) {
                    //         $.modal.close();
                    //         parent.$.modal.msgSuccess(result.msg);
                    //         parent.$.table.refresh();
                    //     } else {
                    //         $.modal.msgReload("发布成功,正在刷新数据请稍后……", modal_status.SUCCESS);
                    //     }
                    // } else {
                    //     $.modal.alertError(result.msg);
                    // }
                    // $.modal.closeLoading();
                    // $.modal.enable();
                }
            });
        }
    }

</script>
</body>
</html>